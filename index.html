import React, { useState, useEffect } from 'react';
// Hapus import langsung yang menyebabkan error
// import { createClient } from '@supabase/supabase-js'; 
import { 
  User, Lock, MapPin, Calendar, CheckCircle, 
  XCircle, Clock, FileText, Download, Users, 
  LogOut, Plus, Trash2, GraduationCap, School,
  ChevronDown, Loader2
} from 'lucide-react';

// --- KONFIGURASI SUPABASE ---
// GANTI DENGAN KUNCI DARI DASHBOARD SUPABASE ANDA
const SUPABASE_URL = 'https://uecprhoqoojuzpqohekj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlY3ByaG9xb29qdXpwcW9oZWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2OTU4MDEsImV4cCI6MjA3OTI3MTgwMX0.oBBW8ZAuSmqXe_5SoQce0_z-9buXrbTmI5bUzDh2QAc';

// --- UTILS ---
const mockBcryptHash = (text) => `hashed_${text.split('').reverse().join('')}`;
const mockVerifyPassword = (input, storedHash) => mockBcryptHash(input) === storedHash;
const CLASSES = ['X-A', 'X-B', 'XI-IPA', 'XI-IPS', 'XII-IPA', 'XII-IPS'];

export default function App() {
  // --- STATE MANAGEMENT ---
  const [supabase, setSupabase] = useState(null); // Client Supabase disimpan di state
  const [isSupabaseReady, setIsSupabaseReady] = useState(false);
  
  const [users, setUsers] = useState([]);
  const [attendance, setAttendance] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [loading, setLoading] = useState(false);
  const [dataLoading, setDataLoading] = useState(true);

  // --- INIT SUPABASE VIA CDN ---
  useEffect(() => {
    // Kita load script Supabase secara manual karena import module tidak tersedia di env ini
    if (window.supabase) {
      const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      setSupabase(client);
      setIsSupabaseReady(true);
      return;
    }

    const script = document.createElement('script');
    script.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
    script.async = true;
    script.onload = () => {
      console.log("Supabase script loaded");
      const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      setSupabase(client);
      setIsSupabaseReady(true);
    };
    script.onerror = () => {
        console.error("Gagal memuat script Supabase");
        alert("Gagal menghubungkan ke layanan Database. Cek koneksi internet.");
    };
    document.body.appendChild(script);

    return () => {
      // Cleanup jika perlu (biasanya script dibiarkan saja)
    };
  }, []);

  // --- DATA FETCHING (SUPABASE) ---
  const fetchData = async () => {
    if (!supabase) return;

    setDataLoading(true);
    try {
      // Ambil Users
      const { data: usersData, error: usersError } = await supabase
        .from('users')
        .select('*');
      
      if (usersError) throw usersError;
      if (usersData) setUsers(usersData);

      // Ambil Attendance
      const { data: attData, error: attError } = await supabase
        .from('attendance')
        .select('*')
        .order('id', { ascending: false });

      if (attError) throw attError;
      if (attData) setAttendance(attData);

    } catch (error) {
      console.error("Error fetching data:", error.message);
    } finally {
      setDataLoading(false);
    }
  };

  // Fetch data saat supabase siap
  useEffect(() => {
    if (isSupabaseReady) {
      fetchData();
      // Cek sesi login lokal
      const savedSession = sessionStorage.getItem('sman1_user_session');
      if (savedSession) {
        setCurrentUser(JSON.parse(savedSession));
      }
    }
  }, [isSupabaseReady]); // Hapus 'supabase' dari deps untuk hindari loop jika obj berubah referensi

  // --- ACTIONS ---

  const handleLogin = async (username, password, role, classId) => {
    if (!supabase) return;
    setLoading(true);
    try {
      // 1. Cari user di database
      const { data: foundUsers, error } = await supabase
        .from('users')
        .select('*')
        .eq('username', username)
        .single(); // single() return object atau null/error jika tidak ada/banyak

      // Supabase .single() bisa throw error jika row tidak ditemukan (code: PGRST116)
      // Kita handle logic-nya:
      
      let userToLogin = foundUsers;

      if (!userToLogin && error && error.code !== 'PGRST116') {
         throw error; // Error beneran (koneksi dll)
      }

      if (userToLogin) {
        // LOGIN USER LAMA
        if (mockVerifyPassword(password, userToLogin.password)) {
           if (userToLogin.role !== role) {
             alert(`Username '${username}' terdaftar sebagai ${userToLogin.role}, bukan ${role}.`);
             setLoading(false);
             return;
           }
           // Login Sukses
           sessionStorage.setItem('sman1_user_session', JSON.stringify(userToLogin));
           setCurrentUser(userToLogin);
        } else {
          alert("Password salah!");
        }
      } else {
        // REGISTER USER BARU (Auto-Register jika user tidak ditemukan)
        const newUserPayload = {
          username: username,
          password: mockBcryptHash(password),
          role: role,
          name: username,
          class_id: role === 'admin' ? null : classId
        };

        const { data: newUser, error: insertError } = await supabase
          .from('users')
          .insert([newUserPayload])
          .select()
          .single();
        
        if (insertError) throw insertError;

        setUsers(prev => [...prev, newUser]);
        sessionStorage.setItem('sman1_user_session', JSON.stringify(newUser));
        setCurrentUser(newUser);
        alert(`Akun baru dibuat sebagai ${role}!`);
      }
    } catch (err) {
      console.error(err);
      alert("Terjadi kesalahan (pastikan URL & Key Supabase sudah diisi): " + err.message);
    } finally {
      setLoading(false);
    }
  };

  const handleLogout = () => {
    sessionStorage.removeItem('sman1_user_session');
    setCurrentUser(null);
  };

  const handleCheckIn = async (status, note, location) => {
    if (!supabase) return;
    const now = new Date();
    const dateStr = now.toISOString().split('T')[0];
    const timeStr = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
    
    // Cek duplikasi lokal
    const alreadyCheckedIn = attendance.find(
      a => a.user_id === currentUser.id && a.date === dateStr
    );

    if (alreadyCheckedIn) {
      alert("Anda sudah melakukan presensi hari ini.");
      return;
    }

    const newRecord = {
      user_id: currentUser.id,
      name: currentUser.name,
      class_id: currentUser.class_id,
      date: dateStr,
      time: timeStr,
      status,
      location: location || "Lokasi Sekolah",
      note: note || "-"
    };

    try {
      const { data, error } = await supabase
        .from('attendance')
        .insert([newRecord])
        .select()
        .single();

      if (error) throw error;

      setAttendance(prev => [data, ...prev]);
      alert(`Berhasil Check-in: ${status}`);
    } catch (err) {
      alert("Gagal menyimpan presensi: " + err.message);
    }
  };

  // --- ADMIN ACTIONS ---
  const handleAddUserAdmin = async (userData) => {
    if(!supabase) return;
    try {
        const { data, error } = await supabase
            .from('users')
            .insert([{
                ...userData,
                password: mockBcryptHash(userData.password)
            }])
            .select()
            .single();
        
        if(error) throw error;
        setUsers([...users, data]);
        alert("User berhasil ditambahkan ke Database!");
    } catch (err) {
        alert("Gagal menambah user: " + err.message);
    }
  };

  const handleDeleteUserAdmin = async (id) => {
      if(!supabase) return;
      if (!confirm("Hapus user ini dari Database?")) return;
      try {
          const { error } = await supabase.from('users').delete().eq('id', id);
          if(error) throw error;
          setUsers(users.filter(u => u.id !== id));
      } catch (err) {
          alert("Gagal menghapus: " + err.message);
      }
  };
  
  const handleDeleteAttendance = async (id) => {
      if(!supabase) return;
      if(!confirm("Hapus catatan ini permanen?")) return;
      try {
          const { error } = await supabase.from('attendance').delete().eq('id', id);
          if(error) throw error;
          setAttendance(attendance.filter(a => a.id !== id));
      } catch(err) {
          alert("Gagal menghapus: " + err.message);
      }
  }

  // --- RENDERER ---

  // Screen Loading Script Supabase
  if (!isSupabaseReady) {
    return (
        <div className="min-h-screen flex items-center justify-center bg-gray-50 flex-col">
            <Loader2 className="animate-spin text-green-600 mb-4" size={48} />
            <h2 className="text-lg font-bold text-gray-700">Memuat Sistem Database...</h2>
            <p className="text-gray-500 text-sm mt-2">Menghubungkan ke library Supabase</p>
        </div>
    )
  }

  if (!currentUser) {
    return <LoginPage onLogin={handleLogin} loading={loading} />;
  }

  // Screen Loading Data Database (setelah login)
  if (dataLoading && users.length === 0 && !currentUser) { 
     // logic check users.length == 0 ini agak tricky jika db emang kosong, 
     // tapi gpp buat indikasi awal
     // kita skip loading screen jika user null (masuk login page)
  }

  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-800">
      <Navbar user={currentUser} onLogout={handleLogout} />
      <main className="container mx-auto p-4 md:p-6">
        {currentUser.role === 'student' && (
          <StudentDashboard user={currentUser} attendance={attendance} onCheckIn={handleCheckIn} />
        )}
        {currentUser.role === 'teacher' && (
          <TeacherDashboard user={currentUser} attendance={attendance} users={users} setAttendance={setAttendance} onDelete={handleDeleteAttendance} />
        )}
        {currentUser.role === 'admin' && (
          <AdminDashboard users={users} onAddUser={handleAddUserAdmin} onDeleteUser={handleDeleteUserAdmin} attendance={attendance} />
        )}
      </main>
    </div>
  );
}

// --- SUB-COMPONENTS ---

function LoginPage({ onLogin, loading }) {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [role, setRole] = useState('student');
  const [selectedClass, setSelectedClass] = useState(CLASSES[0]);

  const handleSubmit = (e) => {
    e.preventDefault();
    onLogin(username, password, role, selectedClass);
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-600 to-blue-700 p-4">
      <div className="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden">
        <div className="bg-gray-50 p-6 text-center border-b border-gray-100">
          <div className="inline-flex items-center justify-center w-16 h-16 bg-green-100 text-green-600 rounded-full mb-4">
            <School size={32} />
          </div>
          <h1 className="text-2xl font-bold text-gray-800">SMAN 1 DRAMAGA</h1>
          <p className="text-gray-500 text-sm mt-1">Sistem Absensi Online (Supabase)</p>
        </div>
        
        <form onSubmit={handleSubmit} className="p-8 space-y-5">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Login Sebagai</label>
            <div className="grid grid-cols-3 gap-2">
              {['student', 'teacher', 'admin'].map(r => (
                  <button
                    key={r} type="button" onClick={() => setRole(r)}
                    className={`py-2 px-1 text-sm rounded-lg border capitalize transition ${role === r ? 'bg-green-600 text-white border-green-600' : 'bg-white text-gray-600 hover:bg-gray-50'}`}
                  >
                    {r === 'student' ? 'Siswa' : r === 'teacher' ? 'Guru' : 'Admin'}
                  </button>
              ))}
            </div>
          </div>

          {role !== 'admin' && (
            <div className="animate-fade-in">
              <label className="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label>
              <div className="relative">
                <ChevronDown className="absolute right-3 top-3 text-gray-400 pointer-events-none" size={20} />
                <select 
                  value={selectedClass} 
                  onChange={(e) => setSelectedClass(e.target.value)}
                  className="w-full pl-4 pr-10 py-2 border border-gray-300 rounded-lg outline-none bg-white"
                >
                  {CLASSES.map((cls) => <option key={cls} value={cls}>{cls}</option>)}
                </select>
              </div>
            </div>
          )}

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Username</label>
            <div className="relative">
              <User className="absolute left-3 top-3 text-gray-400" size={20} />
              <input
                type="text" required
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
                placeholder="Username"
                value={username} onChange={(e) => setUsername(e.target.value)}
              />
            </div>
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
            <div className="relative">
              <Lock className="absolute left-3 top-3 text-gray-400" size={20} />
              <input
                type="password" required
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
                placeholder="Password"
                value={password} onChange={(e) => setPassword(e.target.value)}
              />
            </div>
          </div>

          <button
            type="submit" disabled={loading}
            className="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition duration-300 shadow-md disabled:opacity-50"
          >
            {loading ? 'Menghubungkan...' : 'Masuk / Daftar Otomatis'}
          </button>
          
          <p className="text-xs text-center text-gray-400 mt-2">
             Pastikan URL & Key Supabase sudah diisi di kode.
          </p>
        </form>
      </div>
    </div>
  );
}

function Navbar({ user, onLogout }) {
  return (
    <nav className="bg-white shadow-md sticky top-0 z-10">
      <div className="container mx-auto px-4 py-3 flex justify-between items-center">
        <div className="flex items-center space-x-3">
          <div className="bg-green-600 p-2 rounded-lg text-white"><GraduationCap size={24} /></div>
          <div>
            <h2 className="font-bold text-lg leading-none text-green-700">SMAN 1 DRAMAGA</h2>
            <p className="text-xs text-gray-500 mt-1">Mode Online (Database)</p>
          </div>
        </div>
        <div className="flex items-center space-x-4">
          <div className="hidden md:block text-right">
            <p className="text-sm font-semibold text-gray-800">{user.name}</p>
            {user.class_id && <p className="text-xs text-gray-500">Kelas {user.class_id}</p>}
          </div>
          <button onClick={onLogout} className="p-2 text-red-500 hover:bg-red-50 rounded-full transition"><LogOut size={20} /></button>
        </div>
      </div>
    </nav>
  );
}

function StudentDashboard({ user, attendance, onCheckIn }) {
  const [gpsLoc, setGpsLoc] = useState(null);
  const [note, setNote] = useState('');
  const [status, setStatus] = useState('Hadir');

  const history = attendance.filter(a => a.user_id === user.id).sort((a, b) => b.id - a.id);
  const today = new Date().toISOString().split('T')[0];
  const hasCheckedIn = history.some(h => h.date === today);

  const getLocation = () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => setGpsLoc(`${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`),
        () => setGpsLoc("Error GPS")
      );
    } else {
      setGpsLoc("Browser tidak support GPS");
    }
  };

  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div className="md:col-span-1 space-y-6">
        <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h3 className="text-lg font-bold mb-4 flex items-center text-gray-800">
            <Clock className="mr-2 text-green-600" size={20} /> Presensi Hari Ini
          </h3>
          
          {hasCheckedIn ? (
            <div className="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
              <CheckCircle className="mx-auto text-green-500 mb-2" size={40} />
              <p className="text-green-800 font-medium">Anda sudah presensi hari ini.</p>
            </div>
          ) : (
            <div className="space-y-4">
              <div className="grid grid-cols-3 gap-2">
                {['Hadir', 'Izin', 'Sakit'].map(opt => (
                  <button key={opt} onClick={() => setStatus(opt)} className={`py-2 px-1 rounded-lg text-sm font-medium border transition ${status === opt ? 'bg-blue-600 text-white' : 'bg-white text-gray-600'}`}>{opt}</button>
                ))}
              </div>
              {(status === 'Izin' || status === 'Sakit') && (
                <textarea className="w-full p-3 text-sm border rounded-lg" placeholder="Alasan..." value={note} onChange={(e) => setNote(e.target.value)} />
              )}
              <div className="flex items-center justify-between bg-gray-50 p-3 rounded-lg text-xs text-gray-500">
                <span className="flex items-center"><MapPin size={14} className="mr-1" /> {gpsLoc || "Mencari lokasi..."}</span>
                <button onClick={getLocation} className="text-blue-600 hover:underline">Refresh</button>
              </div>
              <button onClick={() => onCheckIn(status, note, gpsLoc)} className="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold shadow-lg">Kirim Presensi</button>
            </div>
          )}
        </div>
      </div>

      <div className="md:col-span-2">
        <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div className="p-4 border-b bg-gray-50 font-semibold">Riwayat</div>
            <div className="overflow-x-auto">
                <table className="w-full text-sm text-left">
                <thead className="bg-white text-gray-600 border-b">
                    <tr><th className="py-3 px-4">Tanggal</th><th className="px-4">Jam</th><th className="px-4">Status</th><th className="px-4">Ket</th></tr>
                </thead>
                <tbody>
                    {history.map(row => (
                    <tr key={row.id} className="border-b hover:bg-gray-50">
                        <td className="py-3 px-4">{row.date}</td>
                        <td className="px-4 font-mono text-xs">{row.time}</td>
                        <td className="px-4"><span className="px-2 py-1 bg-gray-100 rounded text-xs">{row.status}</span></td>
                        <td className="px-4 text-gray-500">{row.note}</td>
                    </tr>
                    ))}
                    {history.length === 0 && <tr><td colSpan={4} className="p-4 text-center text-gray-400">Kosong</td></tr>}
                </tbody>
                </table>
            </div>
        </div>
      </div>
    </div>
  );
}

function TeacherDashboard({ user, attendance, users, onDelete }) {
  const [filterDate, setFilterDate] = useState(new Date().toISOString().split('T')[0]);
  
  const classStudents = users.filter(u => u.role === 'student' && u.class_id === user.class_id);
  const studentIds = classStudents.map(s => s.id);
  
  const classAttendance = attendance.filter(a => 
    studentIds.includes(a.user_id) && 
    (filterDate === '' || a.date === filterDate)
  );

  const exportCSV = () => {
    let csvContent = "data:text/csv;charset=utf-8,Nama,Kelas,Tanggal,Jam,Status,Catatan\n";
    classAttendance.forEach(row => {
      csvContent += `${row.name},${row.class_id},${row.date},${row.time},${row.status},${row.note}\n`;
    });
    const link = document.createElement("a");
    link.setAttribute("href", encodeURI(csvContent));
    link.setAttribute("download", `rekap_${user.class_id}_${filterDate}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <div className="bg-white rounded-xl shadow-sm border p-6">
        <div className="flex justify-between items-center mb-4">
            <h2 className="text-lg font-bold">Kelas {user.class_id}</h2>
            <div className="flex gap-2">
                <input type="date" value={filterDate} onChange={e => setFilterDate(e.target.value)} className="border p-2 rounded text-sm"/>
                <button onClick={exportCSV} className="bg-blue-600 text-white p-2 rounded flex items-center text-sm"><Download size={16} className="mr-1"/> CSV</button>
            </div>
        </div>
        <table className="w-full text-sm">
            <thead className="bg-gray-100 text-left">
                <tr><th className="p-3">Nama</th><th className="p-3">Waktu</th><th className="p-3">Status</th><th className="p-3">Aksi</th></tr>
            </thead>
            <tbody>
                {classStudents.map(student => {
                    const log = classAttendance.find(a => a.user_id === student.id);
                    return (
                        <tr key={student.id} className="border-b">
                            <td className="p-3">{student.name}</td>
                            <td className="p-3">{log ? log.time : '-'}</td>
                            <td className="p-3">{log ? log.status : <span className="text-red-500">Alfa</span>}</td>
                            <td className="p-3">
                                {log && <button onClick={() => onDelete(log.id)} className="text-red-500"><Trash2 size={16}/></button>}
                            </td>
                        </tr>
                    )
                })}
            </tbody>
        </table>
    </div>
  );
}

function AdminDashboard({ users, onAddUser, onDeleteUser, attendance }) {
  const [newUser, setNewUser] = useState({ username: '', password: '', name: '', role: 'student', class_id: 'X-A' });

  const handleAdd = (e) => {
    e.preventDefault();
    onAddUser(newUser);
    setNewUser({ username: '', password: '', name: '', role: 'student', class_id: 'X-A' });
  };

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-xl shadow-sm">
            <h3 className="font-bold mb-4">Tambah User</h3>
            <form onSubmit={handleAdd} className="space-y-3">
                <input placeholder="Username" className="w-full p-2 border rounded" value={newUser.username} onChange={e => setNewUser({...newUser, username: e.target.value})} required />
                <input placeholder="Password" type="password" className="w-full p-2 border rounded" value={newUser.password} onChange={e => setNewUser({...newUser, password: e.target.value})} required />
                <input placeholder="Nama Lengkap" className="w-full p-2 border rounded" value={newUser.name} onChange={e => setNewUser({...newUser, name: e.target.value})} required />
                <div className="flex gap-2">
                    <select className="p-2 border rounded flex-1" value={newUser.role} onChange={e => setNewUser({...newUser, role: e.target.value})}>
                        <option value="student">Siswa</option>
                        <option value="teacher">Wali Kelas</option>
                        <option value="admin">Admin</option>
                    </select>
                    {newUser.role !== 'admin' && (
                        <select className="p-2 border rounded flex-1" value={newUser.class_id} onChange={e => setNewUser({...newUser, class_id: e.target.value})}>
                            {CLASSES.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                    )}
                </div>
                <button className="w-full bg-green-600 text-white py-2 rounded">Simpan ke Database</button>
            </form>
        </div>

        <div className="bg-white p-6 rounded-xl shadow-sm">
            <h3 className="font-bold mb-4">Total User: {users.length}</h3>
            <div className="h-64 overflow-y-auto border rounded">
                <table className="w-full text-sm text-left">
                    <thead className="bg-gray-50 sticky top-0">
                        <tr><th className="p-2">Nama</th><th className="p-2">Role</th><th className="p-2 text-right">Aksi</th></tr>
                    </thead>
                    <tbody>
                        {users.map(u => (
                            <tr key={u.id} className="border-b">
                                <td className="p-2">{u.name}</td>
                                <td className="p-2">{u.role}</td>
                                <td className="p-2 text-right">
                                    <button onClick={() => onDeleteUser(u.id)} className="text-red-500"><Trash2 size={16}/></button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
  );
}