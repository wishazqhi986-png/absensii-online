<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMAN 1 Dramaga - Sistem Absensi</title>
    
    <!-- Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS (Database) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Lucide Icons (Ikon) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <!-- ================= NAVBAR ================= -->
    <nav id="navbar" class="bg-white shadow-md sticky top-0 z-50 hidden">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-green-600 p-2 rounded-lg text-white">
                    <i data-lucide="graduation-cap"></i>
                </div>
                <div>
                    <h2 class="font-bold text-lg leading-none text-green-700">SMAN 1 DRAMAGA</h2>
                    <p class="text-xs text-gray-500 mt-1">Sistem Online (HTML + Supabase)</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="hidden md:block text-right">
                    <p id="nav-user-name" class="text-sm font-semibold text-gray-800">User</p>
                    <p id="nav-user-class" class="text-xs text-gray-500">Role</p>
                </div>
                <button onclick="handleLogout()" class="p-2 text-red-500 hover:bg-red-50 rounded-full transition" title="Keluar">
                    <i data-lucide="log-out"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- ================= MAIN CONTENT ================= -->
    <main class="container mx-auto p-4 md:p-6 flex-grow relative">
        
        <!-- LOADING OVERLAY -->
        <div id="loading-screen" class="fixed inset-0 bg-white z-[60] flex flex-col items-center justify-center">
            <div class="animate-spin text-green-600 mb-4">
                <i data-lucide="loader-2" width="48" height="48"></i>
            </div>
            <h2 class="text-lg font-bold text-gray-700">Memuat Sistem...</h2>
            <p class="text-gray-500 text-sm mt-2">Menghubungkan ke Database</p>
        </div>

        <!-- VIEW: LOGIN PAGE -->
        <div id="view-login" class="hidden min-h-[80vh] flex items-center justify-center fade-in">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden">
                <div class="bg-gray-50 p-6 text-center border-b border-gray-100">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 text-green-600 rounded-full mb-4">
                        <i data-lucide="school" width="32" height="32"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">LOGIN PRESENSI</h1>
                    <p class="text-gray-500 text-sm mt-1">Masuk atau Daftar Otomatis</p>
                </div>
                
                <form onsubmit="handleLogin(event)" class="p-8 space-y-5">
                    <!-- Role Selector -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Login Sebagai</label>
                        <div class="grid grid-cols-3 gap-2" id="role-buttons">
                            <button type="button" onclick="setRole('student')" class="role-btn py-2 px-1 text-sm rounded-lg border transition bg-green-600 text-white border-green-600" data-role="student">Siswa</button>
                            <button type="button" onclick="setRole('teacher')" class="role-btn py-2 px-1 text-sm rounded-lg border transition bg-white text-gray-600 hover:bg-gray-50" data-role="teacher">Guru</button>
                            <button type="button" onclick="setRole('admin')" class="role-btn py-2 px-1 text-sm rounded-lg border transition bg-white text-gray-600 hover:bg-gray-50" data-role="admin">Admin</button>
                        </div>
                    </div>

                    <!-- Class Selector -->
                    <div id="input-class-container">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label>
                        <select id="login-class" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none bg-white">
                            <option value="X-A">X-A</option>
                            <option value="X-B">X-B</option>
                            <option value="XI-IPA">XI-IPA</option>
                            <option value="XI-IPS">XI-IPS</option>
                            <option value="XII-IPA">XII-IPA</option>
                            <option value="XII-IPS">XII-IPS</option>
                        </select>
                    </div>

                    <!-- Inputs -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="login-username" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" placeholder="Username">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="login-password" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" placeholder="Password">
                    </div>

                    <button type="submit" id="btn-login" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition duration-300 shadow-md">
                        Masuk / Daftar
                    </button>
                    <p class="text-xs text-center text-gray-400 mt-2">Pastikan URL & Key Supabase sudah diisi di script.</p>
                </form>
            </div>
        </div>

        <!-- VIEW: STUDENT DASHBOARD -->
        <div id="view-student" class="hidden fade-in space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Check In Card -->
                <div class="md:col-span-1">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <h3 class="text-lg font-bold mb-4 flex items-center text-gray-800">
                            <i data-lucide="clock" class="mr-2 text-green-600"></i> Presensi Hari Ini
                        </h3>
                        
                        <div id="student-already-checkin" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                            <i data-lucide="check-circle" class="mx-auto text-green-500 mb-2 w-10 h-10"></i>
                            <p class="text-green-800 font-medium">Anda sudah presensi hari ini.</p>
                        </div>

                        <div id="student-form-checkin" class="space-y-4">
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setStatus('Hadir')" class="status-btn py-2 rounded-lg text-sm font-medium border bg-blue-600 text-white" data-status="Hadir">Hadir</button>
                                <button onclick="setStatus('Izin')" class="status-btn py-2 rounded-lg text-sm font-medium border bg-white text-gray-600" data-status="Izin">Izin</button>
                                <button onclick="setStatus('Sakit')" class="status-btn py-2 rounded-lg text-sm font-medium border bg-white text-gray-600" data-status="Sakit">Sakit</button>
                            </div>
                            
                            <textarea id="checkin-note" class="hidden w-full p-3 text-sm border rounded-lg" placeholder="Tulis alasan..."></textarea>
                            
                            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg text-xs text-gray-500">
                                <span class="flex items-center"><i data-lucide="map-pin" class="mr-1 w-3 h-3"></i> <span id="gps-loc">Mencari lokasi...</span></span>
                                <button onclick="getGeolocation()" class="text-blue-600 hover:underline">Refresh</button>
                            </div>
                            
                            <button onclick="submitAttendance()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold shadow-lg">Kirim Presensi</button>
                        </div>
                    </div>
                </div>

                <!-- History -->
                <div class="md:col-span-2">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-4 border-b bg-gray-50 font-semibold">Riwayat Kehadiran</div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-white text-gray-600 border-b">
                                    <tr>
                                        <th class="py-3 px-4">Tanggal</th>
                                        <th class="px-4">Jam</th>
                                        <th class="px-4">Status</th>
                                        <th class="px-4">Ket</th>
                                    </tr>
                                </thead>
                                <tbody id="student-history-body">
                                    <!-- Data injected by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: TEACHER DASHBOARD -->
        <div id="view-teacher" class="hidden fade-in">
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-lg font-bold">Rekap Kelas <span id="teacher-class-name"></span></h2>
                    <div class="flex gap-2">
                        <input type="date" id="teacher-filter-date" class="border p-2 rounded text-sm">
                        <button onclick="exportCSV()" class="bg-blue-600 text-white px-4 py-2 rounded flex items-center text-sm">
                            <i data-lucide="download" class="mr-2 w-4 h-4"></i> Ekspor CSV
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3">Nama Siswa</th>
                                <th class="p-3">Waktu</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">Catatan</th>
                                <th class="p-3 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="teacher-table-body">
                            <!-- Data injected JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW: ADMIN DASHBOARD -->
        <div id="view-admin" class="hidden fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Add User -->
                <div class="md:col-span-1 bg-white p-6 rounded-xl shadow-sm h-fit">
                    <h3 class="font-bold mb-4">Tambah User Manual</h3>
                    <form onsubmit="handleAddUser(event)" class="space-y-3">
                        <input id="admin-username" placeholder="Username" class="w-full p-2 border rounded" required>
                        <input id="admin-password" type="password" placeholder="Password" class="w-full p-2 border rounded" required>
                        <input id="admin-name" placeholder="Nama Lengkap" class="w-full p-2 border rounded" required>
                        <select id="admin-role" class="w-full p-2 border rounded" onchange="toggleAdminClassInput()">
                            <option value="student">Siswa</option>
                            <option value="teacher">Guru</option>
                            <option value="admin">Admin</option>
                        </select>
                        <select id="admin-class" class="w-full p-2 border rounded">
                            <option value="X-A">X-A</option>
                            <option value="X-B">X-B</option>
                            <option value="XI-IPA">XI-IPA</option>
                            <option value="XI-IPS">XI-IPS</option>
                            <option value="XII-IPA">XII-IPA</option>
                            <option value="XII-IPS">XII-IPS</option>
                        </select>
                        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
                            Simpan ke Database
                        </button>
                    </form>
                </div>

                <!-- User List -->
                <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold mb-4">Daftar Semua User (<span id="admin-total-users">0</span>)</h3>
                    <div class="h-96 overflow-y-auto border rounded">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="p-2">Nama</th>
                                    <th class="p-2">Username</th>
                                    <th class="p-2">Role</th>
                                    <th class="p-2">Kelas</th>
                                    <th class="p-2 text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="admin-user-list">
                                <!-- Data -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- ================= JAVASCRIPT LOGIC ================= -->
    <script>
        // --- 1. CONFIGURATION ---
        // GANTI DENGAN URL & KEY PROJECT SUPABASE ANDA
        const SUPABASE_URL = 'https://ganti-dengan-url-project-anda.supabase.co';
        const SUPABASE_ANON_KEY = 'ganti-dengan-anon-public-key-anda';
        
        let supabase;
        let currentUser = null;
        let usersData = [];
        let attendanceData = [];
        let currentRole = 'student';
        let currentStatus = 'Hadir';
        let currentGps = null;

        // --- 2. INITIALIZATION ---
        document.addEventListener("DOMContentLoaded", async () => {
            // Init Supabase
            if (typeof window.supabase !== 'undefined') {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase Initialized");
            } else {
                alert("Gagal memuat library Supabase. Cek koneksi internet.");
                return;
            }

            // Init Icons
            lucide.createIcons();

            // Check Local Session
            const savedSession = sessionStorage.getItem('sman1_user_session');
            if (savedSession) {
                currentUser = JSON.parse(savedSession);
                await fetchData(); // Load data
                renderView();
            } else {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('view-login').classList.remove('hidden');
            }

            // Setup Default Date for Teacher
            document.getElementById('teacher-filter-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('teacher-filter-date').addEventListener('change', renderTeacherDashboard);
            
            // Get Location Initially
            getGeolocation();
        });

        // --- 3. UTILS ---
        const mockBcryptHash = (text) => `hashed_${text.split('').reverse().join('')}`;
        const mockVerifyPassword = (input, storedHash) => mockBcryptHash(input) === storedHash;

        function getGeolocation() {
            const locEl = document.getElementById('gps-loc');
            locEl.textContent = "Mencari...";
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        currentGps = `${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
                        locEl.textContent = currentGps;
                    },
                    () => {
                        currentGps = "Error/Block";
                        locEl.textContent = "Gagal akses GPS";
                    }
                );
            } else {
                locEl.textContent = "Browser tidak support";
            }
        }

        // --- 4. DATA FETCHING ---
        async function fetchData() {
            if (!currentUser) return;
            
            // Show loading if needed, mostly transparent though
            try {
                // Fetch Users
                const { data: uData, error: uError } = await supabase.from('users').select('*');
                if (uError) throw uError;
                usersData = uData || [];

                // Fetch Attendance
                const { data: aData, error: aError } = await supabase
                    .from('attendance')
                    .select('*')
                    .order('id', { ascending: false });
                
                if (aError) throw aError;
                attendanceData = aData || [];

            } catch (err) {
                console.error("Error fetching data:", err);
                // Don't alert error continuously
            } finally {
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        // --- 5. AUTHENTICATION ---
        function setRole(role) {
            currentRole = role;
            // Update UI Buttons
            document.querySelectorAll('.role-btn').forEach(btn => {
                const btnRole = btn.getAttribute('data-role');
                if (btnRole === role) {
                    btn.className = "role-btn py-2 px-1 text-sm rounded-lg border transition bg-green-600 text-white border-green-600";
                } else {
                    btn.className = "role-btn py-2 px-1 text-sm rounded-lg border transition bg-white text-gray-600 hover:bg-gray-50";
                }
            });

            // Show/Hide Class Input
            const classContainer = document.getElementById('input-class-container');
            if (role === 'admin') classContainer.classList.add('hidden');
            else classContainer.classList.remove('hidden');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const classId = document.getElementById('login-class').value;
            const btn = document.getElementById('btn-login');

            btn.innerText = "Memproses...";
            btn.disabled = true;

            try {
                // Find user
                const { data: foundUser, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .maybeSingle(); // Safest for 0 or 1 result

                if (error) throw error;

                if (foundUser) {
                    // User Exists -> Verify
                    if (mockVerifyPassword(password, foundUser.password)) {
                        if (foundUser.role !== currentRole) {
                            alert(`Akun ini terdaftar sebagai ${foundUser.role}, bukan ${currentRole}`);
                            btn.innerText = "Masuk / Daftar";
                            btn.disabled = false;
                            return;
                        }
                        // Success
                        currentUser = foundUser;
                    } else {
                        alert("Password salah!");
                        btn.innerText = "Masuk / Daftar";
                        btn.disabled = false;
                        return;
                    }
                } else {
                    // User Not Found -> Auto Register
                    const newUserPayload = {
                        username: username,
                        password: mockBcryptHash(password),
                        role: currentRole,
                        name: username, // Default name
                        class_id: currentRole === 'admin' ? null : classId
                    };

                    const { data: newUser, error: insertError } = await supabase
                        .from('users')
                        .insert([newUserPayload])
                        .select()
                        .single();
                    
                    if (insertError) throw insertError;
                    
                    currentUser = newUser;
                    alert(`Akun baru berhasil dibuat sebagai ${currentRole}!`);
                }

                // Finalize Login
                sessionStorage.setItem('sman1_user_session', JSON.stringify(currentUser));
                await fetchData();
                renderView();

            } catch (err) {
                alert("Error Login: " + err.message);
            } finally {
                btn.innerText = "Masuk / Daftar";
                btn.disabled = false;
            }
        }

        function handleLogout() {
            sessionStorage.removeItem('sman1_user_session');
            currentUser = null;
            location.reload();
        }

        // --- 6. STUDENT LOGIC ---
        function setStatus(status) {
            currentStatus = status;
            
            // Update UI
            document.querySelectorAll('.status-btn').forEach(btn => {
                if (btn.getAttribute('data-status') === status) {
                    btn.className = "status-btn py-2 rounded-lg text-sm font-medium border bg-blue-600 text-white";
                } else {
                    btn.className = "status-btn py-2 rounded-lg text-sm font-medium border bg-white text-gray-600";
                }
            });

            // Show Note for Sakit/Izin
            const noteEl = document.getElementById('checkin-note');
            if (status !== 'Hadir') noteEl.classList.remove('hidden');
            else noteEl.classList.add('hidden');
        }

        async function submitAttendance() {
            const note = document.getElementById('checkin-note').value;
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

            const payload = {
                user_id: currentUser.id,
                name: currentUser.name,
                class_id: currentUser.class_id,
                date: dateStr,
                time: timeStr,
                status: currentStatus,
                location: currentGps || "Lokasi Sekolah",
                note: (currentStatus !== 'Hadir') ? note : '-'
            };

            try {
                const { data, error } = await supabase.from('attendance').insert([payload]).select().single();
                if (error) throw error;
                
                attendanceData.unshift(data); // Add to top
                alert("Berhasil Presensi!");
                renderStudentDashboard(); // Refresh UI
            } catch (err) {
                alert("Gagal: " + err.message);
            }
        }

        // --- 7. ADMIN LOGIC ---
        function toggleAdminClassInput() {
            const role = document.getElementById('admin-role').value;
            const classInput = document.getElementById('admin-class');
            if (role === 'admin') classInput.classList.add('hidden');
            else classInput.classList.remove('hidden');
        }

        async function handleAddUser(e) {
            e.preventDefault();
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            const name = document.getElementById('admin-name').value;
            const role = document.getElementById('admin-role').value;
            const classId = document.getElementById('admin-class').value;

            try {
                const { data, error } = await supabase.from('users').insert([{
                    username,
                    password: mockBcryptHash(password),
                    name,
                    role,
                    class_id: role === 'admin' ? null : classId
                }]).select().single();

                if (error) throw error;

                usersData.push(data);
                alert("User ditambahkan");
                renderAdminDashboard();
                e.target.reset(); // Reset form
            } catch (err) {
                alert("Gagal tambah user: " + err.message);
            }
        }

        async function deleteUser(id) {
            if (!confirm("Hapus user ini permanen?")) return;
            try {
                const { error } = await supabase.from('users').delete().eq('id', id);
                if (error) throw error;
                
                usersData = usersData.filter(u => u.id !== id);
                renderAdminDashboard();
            } catch (err) {
                alert("Gagal hapus: " + err.message);
            }
        }

        // --- 8. TEACHER LOGIC ---
        async function deleteAttendance(id) {
            if (!confirm("Hapus data presensi ini?")) return;
            try {
                const { error } = await supabase.from('attendance').delete().eq('id', id);
                if (error) throw error;

                attendanceData = attendanceData.filter(a => a.id !== id);
                renderTeacherDashboard();
            } catch (err) {
                alert("Gagal hapus: " + err.message);
            }
        }

        function exportCSV() {
            const filterDate = document.getElementById('teacher-filter-date').value;
            const myClassStudents = usersData.filter(u => u.role === 'student' && u.class_id === currentUser.class_id).map(u => u.id);
            const logs = attendanceData.filter(a => myClassStudents.includes(a.user_id) && (filterDate === '' || a.date === filterDate));

            let csvContent = "data:text/csv;charset=utf-8,Nama,Kelas,Tanggal,Jam,Status,Catatan\n";
            logs.forEach(row => {
                csvContent += `${row.name},${row.class_id},${row.date},${row.time},${row.status},${row.note}\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `rekap_absensi_${currentUser.class_id}_${filterDate}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- 9. RENDERING ---
        function renderView() {
            // Hide All
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-student').classList.add('hidden');
            document.getElementById('view-teacher').classList.add('hidden');
            document.getElementById('view-admin').classList.add('hidden');
            
            // Show Navbar
            document.getElementById('navbar').classList.remove('hidden');
            document.getElementById('nav-user-name').textContent = currentUser.name;
            document.getElementById('nav-user-class').textContent = currentUser.role.toUpperCase() + (currentUser.class_id ? ` - ${currentUser.class_id}` : '');

            if (currentUser.role === 'student') {
                document.getElementById('view-student').classList.remove('hidden');
                renderStudentDashboard();
            } else if (currentUser.role === 'teacher') {
                document.getElementById('view-teacher').classList.remove('hidden');
                renderTeacherDashboard();
            } else if (currentUser.role === 'admin') {
                document.getElementById('view-admin').classList.remove('hidden');
                renderAdminDashboard();
            }
            lucide.createIcons();
        }

        function renderStudentDashboard() {
            // 1. Check if already attended today
            const today = new Date().toISOString().split('T')[0];
            const hasCheckedIn = attendanceData.some(a => a.user_id === currentUser.id && a.date === today);
            
            if (hasCheckedIn) {
                document.getElementById('student-already-checkin').classList.remove('hidden');
                document.getElementById('student-form-checkin').classList.add('hidden');
            } else {
                document.getElementById('student-already-checkin').classList.add('hidden');
                document.getElementById('student-form-checkin').classList.remove('hidden');
            }

            // 2. Render History Table
            const myHistory = attendanceData.filter(a => a.user_id === currentUser.id);
            const tbody = document.getElementById('student-history-body');
            tbody.innerHTML = '';
            
            if (myHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-400">Belum ada data</td></tr>';
                return;
            }

            myHistory.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="py-3 px-4">${row.date}</td>
                    <td class="px-4 font-mono text-xs">${row.time}</td>
                    <td class="px-4"><span class="px-2 py-1 bg-gray-100 rounded text-xs">${row.status}</span></td>
                    <td class="px-4 text-gray-500 text-xs">${row.note}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderTeacherDashboard() {
            document.getElementById('teacher-class-name').textContent = currentUser.class_id;
            const filterDate = document.getElementById('teacher-filter-date').value;
            
            // Filter siswa di kelas ini
            const studentsInClass = usersData.filter(u => u.role === 'student' && u.class_id === currentUser.class_id);
            const tbody = document.getElementById('teacher-table-body');
            tbody.innerHTML = '';

            if (studentsInClass.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-400">Tidak ada siswa di kelas ini</td></tr>';
                return;
            }

            studentsInClass.forEach(student => {
                const log = attendanceData.find(a => a.user_id === student.id && a.date === filterDate);
                
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50";
                
                let statusBadge = log 
                    ? `<span class="px-2 py-1 rounded-full text-xs font-semibold ${
                        log.status === 'Hadir' ? 'bg-green-100 text-green-700' : 
                        log.status === 'Sakit' ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700'
                      }">${log.status}</span>`
                    : `<span class="text-red-500 text-xs font-bold bg-red-50 px-2 py-1 rounded">Alfa</span>`;
                
                tr.innerHTML = `
                    <td class="p-3 font-medium">${student.name}</td>
                    <td class="p-3 text-gray-600">${log ? log.time : '-'}</td>
                    <td class="p-3">${statusBadge}</td>
                    <td class="p-3 text-gray-500 italic text-xs">${log ? log.note : '-'}</td>
                    <td class="p-3 text-right">
                        ${log ? `<button onclick="deleteAttendance(${log.id})" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" width="16"></i></button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        function renderAdminDashboard() {
            document.getElementById('admin-total-users').textContent = usersData.length;
            const tbody = document.getElementById('admin-user-list');
            tbody.innerHTML = '';

            usersData.forEach(u => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="p-2 font-medium">${u.name}</td>
                    <td class="p-2 text-gray-500 text-xs">${u.username}</td>
                    <td class="p-2 capitalize text-xs">${u.role}</td>
                    <td class="p-2 text-xs">${u.class_id || '-'}</td>
                    <td class="p-2 text-right">
                        ${u.username !== 'admin' ? `<button onclick="deleteUser(${u.id})" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" width="16"></i></button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

    </script>
</body>
</html>
